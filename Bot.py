import asyncio
import requests
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

# === –¢–û–ö–ï–ù–´ ===
TELEGRAM_TOKEN = "8449356928:AAHYsxrgjmXcxx9Tf1QD5sq2FHbf6wcuyOw"
OPENWEATHER_API_KEY = "467757e49e43bf858cd8944db3808a2e"

# –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è
CITIES = {
    "–ê—á–∏–Ω—Å–∫": (56.2694, 90.4993),
    "–ë–æ–≥–æ—Ç–æ–ª": (56.20778, 89.53417),
    "–ë–æ—Ä–æ–¥–∏–Ω–æ": (55.90786, 94.90264),
    "–î–∏–≤–Ω–æ–≥–æ—Ä—Å–∫": (55.9581, 92.5208),
    "–ï–Ω–∏—Å–µ–π—Å–∫": (58.44937, 92.17968),
    "–ñ–µ–ª–µ–∑–Ω–æ–≥–æ—Ä—Å–∫": (56.0078, 92.9008),
    "–ó–∞–æ–∑—ë—Ä–Ω—ã–π": (55.9742134, 94.7096332),
    "–ó–µ–ª–µ–Ω–æ–≥–æ—Ä—Å–∫": (56.1124, 94.5985),
    "–ò–≥–∞—Ä–∫–∞": (67.472042, 86.55882),
    "–ò–ª–∞–Ω—Å–∫–∏–π": (56.23250, 96.06520),
    "–ö–∞–Ω—Å–∫": (56.2033, 95.4017),
    "–ö–æ–¥–∏–Ω—Å–∫": (58.60767, 99.17791),
    "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫": (56.0184, 92.8672),
    "–õ–µ—Å–æ—Å–∏–±–∏—Ä—Å–∫": (58.2192, 92.4189),
    "–ú–∏–Ω—É—Å–∏–Ω—Å–∫": (53.7167, 91.6833),
    "–ù–∞–∑–∞—Ä–æ–≤–æ": (56.0269, 92.0164),
    "–ù–æ—Ä–∏–ª—å—Å–∫": (69.3535, 88.2027),
    "–°–æ—Å–Ω–æ–≤–æ–±–æ—Ä—Å–∫": (56.12170, 93.33850),
    "–£–∂—É—Ä": (55.31246, 89.83301),
    "–£—è—Ä": (55.810567, 94.329052),
    "–®–∞—Ä—ã–ø–æ–≤–æ": (55.54028, 89.20083),
}

# –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
SOURCES = {
    "–ù–æ—Ä–∏–ª—å—Å–∫": "–¶–≤–µ—Ç–Ω–∞—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è: –≤—ã–ø–ª–∞–≤–∫–∞ –Ω–∏–∫–µ–ª—è, –º–µ–¥–∏, –∫–æ–±–∞–ª—å—Ç–∞ (–ü–ê–û ¬´–ù–æ—Ä–Ω–∏–∫–µ–ª—å¬ª)",
    "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫": "–¢–≠–¶, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø—Ä–æ–º–∑–æ–Ω–∞, –º—É—Å–æ—Ä–æ—Å–∂–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–≤–æ–¥",
    "–ê—á–∏–Ω—Å–∫": "–¶–µ–º–µ–Ω—Ç–Ω—ã–π –∑–∞–≤–æ–¥, –¢–≠–¶, –∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
    "–ñ–µ–ª–µ–∑–Ω–æ–≥–æ—Ä—Å–∫": "–ì–æ—Ä–Ω–æ-—Ö–∏–º–∏—á–µ—Å–∫–æ–µ –∏ —è–¥–µ—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ (–ó–ê–¢–û)",
    "–õ–µ—Å–æ—Å–∏–±–∏—Ä—Å–∫": "–õ–µ—Å–æ–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å, –¢–≠–¶",
    "–ú–∏–Ω—É—Å–∏–Ω—Å–∫": "–°–µ–ª—å—Ö–æ–∑–ø—ã–ª—å, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Å–∂–∏–≥–∞–Ω–∏–µ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
    "–ö–∞–Ω—Å–∫": "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø—Ä–æ–º–∑–æ–Ω–∞, –ø—ã–ª—å –æ—Ç –¥–æ—Ä–æ–≥",
    "–ù–∞–∑–∞—Ä–æ–≤–æ": "–£–≥–æ–ª—å–Ω–∞—è –ì–†–≠–°, —Ä–∞–∑—Ä–µ–∑, —Ü–µ–º–µ–Ω—Ç–Ω—ã–π –∑–∞–≤–æ–¥",
    "–î–∏–≤–Ω–æ–≥–æ—Ä—Å–∫": "–ì–≠–°, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –ø—ã–ª—å, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
    "–ë–µ—Ä—ë–∑–æ–≤–∫–∞": "–ü—Ä–æ–º–∑–æ–Ω–∞ ¬´–°–µ–≤–µ—Ä–Ω–∞—è¬ª, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —É–≥–æ–ª—å–Ω—ã–µ —Å–∫–ª–∞–¥—ã",
    "–ó–µ–ª–µ–Ω–æ–≥–æ—Ä—Å–∫": "–Ø–¥–µ—Ä–Ω–æ-—Ç–æ–ø–ª–∏–≤–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ (–ó–ê–¢–û)",
    "–ï–Ω–∏—Å–µ–π—Å–∫": "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Å–∂–∏–≥–∞–Ω–∏–µ –¢–ë–û",
    "–®–∞—Ä—ã–ø–æ–≤–æ": "–£–≥–æ–ª—å–Ω–∞—è –ì–†–≠–°, —Ä–∞–∑—Ä–µ–∑—ã, –ø—ã–ª—å –æ—Ç —É–≥–ª—è",
    "–ò–≥–∞—Ä–∫–∞": "–î–∏–∑–µ–ª—å–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏, —Å–∂–∏–≥–∞–Ω–∏–µ –æ—Ç—Ö–æ–¥–æ–≤",
    "–ë–æ–≥–æ—Ç–æ–ª": "–ñ/–¥ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø—Ä–æ–º–∑–æ–Ω–∞",
    "–£—è—Ä": "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø—ã–ª–µ–≤—ã–µ –±—É—Ä–∏, —Å–∂–∏–≥–∞–Ω–∏–µ –º—É—Å–æ—Ä–∞",
    "–°–æ—Å–Ω–æ–≤–æ–±–æ—Ä—Å–∫": "–ü—Ä–æ–º–∑–æ–Ω–∞, –ø—ã–ª—å –æ—Ç –¥–æ—Ä–æ–≥",
}

# –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º AQI
def get_advice_with_scale(aqi_value):
    if aqi_value == 1:
        return f"üü¢ *{aqi_value}* (0‚Äì50): –í–æ–∑–¥—É—Ö —á–∏—Å—Ç—ã–π. –ú–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ –≥—É–ª—è—Ç—å, –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–ø–æ—Ä—Ç–æ–º –Ω–∞ —É–ª–∏—Ü–µ –∏ –ø—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–º–µ—â–µ–Ω–∏—è."
    elif aqi_value == 2:
        return f"üü° *{aqi_value}* (51‚Äì100): –í–æ–∑–¥—É—Ö –≤ —Ü–µ–ª–æ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, –Ω–æ –ª—é–¥—è–º —Å –∞—Å—Ç–º–æ–π, –∞–ª–ª–µ—Ä–≥–∏–µ–π –∏–ª–∏ –±–æ–ª–µ–∑–Ω—è–º–∏ –ª—ë–≥–∫–∏—Ö —Å—Ç–æ–∏—Ç –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –ª—ë–≥–∫–æ–µ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ä–ª–∞ –∏–ª–∏ –≥–ª–∞–∑."
    elif aqi_value == 3:
        return f"üü† *{aqi_value}* (101‚Äì150): –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ —É–º–µ—Ä–µ–Ω–Ω–æ–µ. –î–µ—Ç—è–º, –ø–æ–∂–∏–ª—ã–º –∏ –ª—é–¥—è–º —Å —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–º–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è–º–∏ ‚Äî –ª—É—á—à–µ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ. –û—Å—Ç–∞–ª—å–Ω—ã–º ‚Äî –±–µ–∑ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π, –Ω–æ –Ω–µ —Å—Ç–æ–∏—Ç –¥–æ–ª–≥–æ –¥—ã—à–∞—Ç—å –≤—ã—Ö–ª–æ–ø–∞–º–∏ –∏–ª–∏ –ø—Ä–æ–º–∑–æ–Ω–æ–π."
    elif aqi_value == 4:
        return f"üî¥ *{aqi_value}* (151‚Äì200): –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–µ. –í—Å–µ –º–æ–≥—É—Ç –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç: –∫–∞—à–µ–ª—å, –ø–µ—Ä—à–µ–Ω–∏–µ, —É—Å—Ç–∞–ª–æ—Å—Ç—å. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–≥—É–ª–∫–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤–±–ª–∏–∑–∏ –¥–æ—Ä–æ–≥ –∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã—Ö –∑–æ–Ω. –î–æ–º–∞ ‚Äî –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞, –≤–∫–ª—é—á–∏—Ç—å –æ—á–∏—Å—Ç–∏—Ç–µ–ª—å –≤–æ–∑–¥—É—Ö–∞, –µ—Å–ª–∏ –µ—Å—Ç—å."
    elif aqi_value >= 5:
        return f"üü£ *{aqi_value}* (>200): –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è! –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –¥–æ–º–∞, –Ω–µ –ø—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–π—Ç–µ, –∏–∑–±–µ–≥–∞–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫. –î–µ—Ç—è–º, –ø–æ–∂–∏–ª—ã–º –∏ –ª—é–¥—è–º —Å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è–º–∏ ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º. –ü—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ ‚Äî –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É."
    return f"‚ÑπÔ∏è AQI: *{aqi_value}* ‚Äî –¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."

# –ï–¥–∏–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
def get_city_keyboard():
    buttons = [KeyboardButton(text=city) for city in CITIES.keys()]
    keyboard = [buttons[i:i + 2] for i in range(0, len(buttons), 2)]
    return ReplyKeyboardMarkup(keyboard=keyboard, resize_keyboard=True)

bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def send_welcome(message: types.Message):
    await message.answer(
        "üåø –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–∫–∞–∑—ã–≤–∞—é –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ –≤ –≥–æ—Ä–æ–¥–∞—Ö –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è.\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –Ω–∏–∂–µ:",
        reply_markup=get_city_keyboard()
    )

@dp.message()
async def handle_messages(message: types.Message):
    text = message.text.strip()
    if text not in CITIES:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞.", reply_markup=get_city_keyboard())
        return

    city = text
    lat, lon = CITIES[city]

    try:
        url = f"http://api.openweathermap.org/data/2.5/air_pollution?lat={lat}&lon={lon}&appid={OPENWEATHER_API_KEY}"
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        data = response.json()["list"][0]

        aqi = data["main"]["aqi"]
        comp = data["components"]

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞ –ë–ï–ó –Ω–æ—Ä–º –í–û–ó/–†–§
        report = (
            f"üèô *{city}*\n"
            f"üåç *AQI*: {aqi}\n\n"
            f"ü´Å *–ó–∞–≥—Ä—è–∑–Ω–∏—Ç–µ–ª–∏:*\n"
            f"‚Ä¢ PM2.5: {comp.get('pm2_5', 0):.1f} –º–∫–≥/–º¬≥\n"
            f"‚Ä¢ PM10: {comp.get('pm10', 0):.1f} –º–∫–≥/–º¬≥\n"
            f"‚Ä¢ NO‚ÇÇ: {comp.get('no2', 0):.1f} –º–∫–≥/–º¬≥\n"
            f"‚Ä¢ SO‚ÇÇ: {comp.get('so2', 0):.1f} –º–∫–≥/–º¬≥\n"
            f"‚Ä¢ CO: {comp.get('co', 0) / 1000:.1f} –º–≥/–º¬≥\n"
            f"‚Ä¢ O‚ÇÉ: {comp.get('o3', 0):.1f} –º–∫–≥/–º¬≥\n\n"
            f"‚ÑπÔ∏è *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*\n{get_advice_with_scale(aqi)}\n\n"
            f"üè≠ *–ò—Å—Ç–æ—á–Ω–∏–∫*: {SOURCES.get(city, '–û–±—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å, –æ—Ç–æ–ø–ª–µ–Ω–∏–µ')}"
        )
        await message.answer(report, parse_mode="Markdown", reply_markup=get_city_keyboard())

    except Exception:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", reply_markup=get_city_keyboard())

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())